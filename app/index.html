<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>xnote</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
      integrity="sha512-8mEs0lZQJ/Ma9R3W1Ti6S5ktl8o3OnpGLtq9bpn9lQHGweJKey3OC8l7Xv+9Vni5g4pMjGfJ9cFz6Fu0Ghy5iA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <style>
      :root {
        color-scheme: dark;
        --bg: #05060a;
        --bg-elevated: #10121a;
        --bg-elevated-soft: #151827;
        --border-subtle: #272a3a;
        --accent: #4f8cff;
        --accent-soft: rgba(79, 140, 255, 0.12);
        --accent-strong: #c5d7ff;
        --text-main: #f5f6ff;
        --text-muted: #a2a7c4;
        --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.55);
      }

      :root[data-theme="light"] {
        color-scheme: light;
        --bg: #f8f6f1;
        --bg-elevated: #fdfcf8;
        --bg-elevated-soft: #f5f3eb;
        --border-subtle: #e5e0d5;
        --accent: #8b6914;
        --accent-soft: rgba(139, 105, 20, 0.08);
        --accent-strong: #6b4f0a;
        --text-main: #3d3929;
        --text-muted: #7a7262;
        --shadow-soft: 0 18px 35px rgba(60, 50, 30, 0.12);
      }

      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      body {
        background: var(--bg);
        color: var(--text-main);
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }

      body.font-serif {
        font-family: "Merriweather", "Times New Roman", serif;
      }

      .shell {
        position: relative;
        height: 100vh;
        width: 100vw;
        display: flex;
        flex-direction: column;
        background: linear-gradient(150deg, rgba(255, 255, 255, 0.02), transparent 55%), var(--bg-elevated);
      }

      .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 12px;
        background: rgba(4, 6, 18, 0.96);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        -webkit-app-region: drag;
      }

      :root[data-theme="light"] .toolbar {
        background: rgba(245, 240, 230, 0.98);
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      }

      .toolbar button, .toolbar .toggle-group {
        -webkit-app-region: no-drag;
      }

      .window-controls {
        display: flex;
        gap: 8px;
        margin-right: 8px;
      }

      .window-btn {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        -webkit-app-region: no-drag;
      }

      .window-close {
        background: #ff5f57;
      }

      .window-close:hover {
        background: #ff3b30;
      }

      .left-group,
      .right-group {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .note-title {
        font-size: 13px;
        font-weight: 600;
        letter-spacing: 0.11em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .pill {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--accent-strong);
        background: var(--accent-soft);
      }

      .toggle-group {
        display: inline-flex;
        border-radius: 999px;
        background: rgba(6, 7, 18, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 2px;
      }

      :root[data-theme="light"] .toggle-group {
        background: rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .toggle-group button {
        cursor: pointer;
        border-radius: 999px;
        border: none;
        background: transparent;
        padding: 3px 9px;
        font-size: 11px;
        min-width: 58px;
        justify-content: center;
        display: inline-flex;
        align-items: center;
        color: var(--text-muted);
        transition: background 140ms ease, color 140ms ease;
      }

      .toggle-group button.is-active {
        background: var(--accent-soft);
        color: var(--accent-strong);
      }

      .body {
        flex: 1;
        display: flex;
        min-height: 0;
      }

      .pane {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      .pane + .pane {
        border-left: 1px solid rgba(255, 255, 255, 0.06);
      }

      .pane-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 12px;
        background: rgba(7, 9, 24, 0.95);
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      }

      :root[data-theme="light"] .pane-header {
        background: rgba(240, 235, 225, 0.95);
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      }

      .pane-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--text-muted);
      }

      .pane-sub {
        font-size: 11px;
        color: var(--text-muted);
      }

      .pane-body {
        flex: 1;
        position: relative;
        min-height: 0;
      }

      #rich-editor,
      #md-input,
      #md-preview {
        position: absolute;
        inset: 0;
        padding: 14px 18px 16px 18px;
        box-sizing: border-box;
        border: none;
        outline: none;
        background: linear-gradient(160deg, var(--bg-elevated), var(--bg-elevated-soft));
        color: var(--text-main);
        font-size: 14px;
        line-height: 1.55;
        overflow: auto;
      }

      #rich-editor[contenteditable="true"]::before {
        content: attr(data-placeholder);
        position: absolute;
        pointer-events: none;
        opacity: 0.32;
      }

      #rich-editor[data-has-content="true"]::before {
        content: "";
      }

      #md-input {
        font-family: "JetBrains Mono", SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        resize: none;
        white-space: pre;
      }

      #md-input::placeholder {
        color: rgba(162, 167, 196, 0.5);
      }

      #md-preview h1,
      #md-preview h2,
      #md-preview h3,
      #md-preview h4 {
        margin-top: 1.4em;
        margin-bottom: 0.4em;
        font-weight: 650;
      }

      #md-preview h1 {
        font-size: 1.7em;
      }

      #md-preview h2 {
        font-size: 1.35em;
      }

      #md-preview h3 {
        font-size: 1.15em;
      }

      #md-preview p {
        margin: 0 0 0.7em 0;
      }

      #md-preview ul,
      #md-preview ol {
        padding-left: 1.3em;
        margin: 0 0 0.7em 0;
      }

      #md-preview code {
        font-family: "JetBrains Mono", SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.9em;
        background: rgba(255, 255, 255, 0.04);
        padding: 1px 4px;
        border-radius: 4px;
      }

      #md-preview pre code {
        background: transparent;
        padding: 0;
      }

      #md-preview pre {
        padding: 10px 12px;
        border-radius: 8px;
        background: rgba(1, 3, 12, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.07);
        overflow: auto;
      }

      #md-preview blockquote {
        margin: 0 0 0.7em 0;
        padding-left: 10px;
        border-left: 2px solid rgba(255, 255, 255, 0.24);
        color: var(--text-muted);
        font-style: italic;
      }

      .status-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 4px 10px;
        font-size: 11px;
        background: rgba(4, 6, 18, 0.96);
        border-top: 1px solid rgba(255, 255, 255, 0.06);
      }

      :root[data-theme="light"] .status-bar {
        background: rgba(245, 240, 230, 0.98);
        border-top: 1px solid rgba(0, 0, 0, 0.08);
      }

      .status-left {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--text-muted);
      }

      .status-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: var(--accent);
        box-shadow: 0 0 0 4px rgba(79, 140, 255, 0.18);
      }

      .status-label {
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 600;
      }

      .status-time {
        opacity: 0.9;
      }

      .status-right {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        color: var(--text-muted);
      }

      .shortcuts span {
        margin-right: 10px;
      }

      .shortcuts kbd {
        font-family: "JetBrains Mono", SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 10px;
        padding: 1px 3px;
        border-radius: 3px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.35);
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 900px) {
        .body {
          flex-direction: column;
        }
        .pane + .pane {
          border-left: none;
          border-top: 1px solid rgba(255, 255, 255, 0.06);
        }
      }
          hr {
        border: none;
        height: 1px;
        background: rgba(255, 255, 255, 0.06);
      }
      :root[data-theme="light"] hr {
        background: rgba(0, 0, 0, 0.08);
      }
      /* stronger pre/code styling */
      #md-preview pre {
        padding: 12px 14px;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.55);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      :root[data-theme="light"] #md-preview pre {
        background: rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(0, 0, 0, 0.08);
      }
      #md-preview pre code {
        color: var(--text-main);
        font-size: 0.95em;
      }

      /* Modal styles */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 150ms ease, visibility 150ms ease;
      }

      .modal-overlay.is-visible {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: var(--bg-elevated);
        border: 1px solid var(--border-subtle);
        border-radius: 10px;
        box-shadow: var(--shadow-soft), 0 0 0 1px rgba(255, 255, 255, 0.03);
        width: 90%;
        max-width: 420px;
        max-height: 70vh;
        display: flex;
        flex-direction: column;
        transform: scale(0.96) translateY(-8px);
        transition: transform 150ms ease;
      }

      .modal-overlay.is-visible .modal {
        transform: scale(1) translateY(0);
      }

      .modal-header {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .modal-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .modal-close {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 2px 6px;
        font-size: 16px;
        line-height: 1;
        border-radius: 4px;
        transition: background 100ms ease;
      }

      .modal-close:hover {
        color: var(--text-main);
        background: rgba(255, 255, 255, 0.06);
      }

      .modal-body {
        padding: 12px 14px;
        overflow-y: auto;
        flex: 1;
      }

      .modal-search {
        width: 100%;
        padding: 7px 10px;
        border: 1px solid var(--border-subtle);
        border-radius: 5px;
        background: var(--bg);
        color: var(--text-main);
        font-size: 12px;
        margin-bottom: 10px;
        box-sizing: border-box;
      }

      .modal-search::placeholder {
        color: var(--text-muted);
      }

      .modal-search:focus {
        outline: none;
        border-color: var(--accent);
      }

      .notes-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .notes-list-item {
        padding: 8px 10px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 100ms ease;
        margin-bottom: 2px;
      }

      .notes-list-item:hover {
        background: rgba(255, 255, 255, 0.04);
      }

      .note-name {
        font-size: 12px;
        color: var(--text-main);
        font-weight: 500;
      }

      .note-date {
        font-size: 10px;
        color: var(--text-muted);
        margin-top: 2px;
      }

      .notes-empty {
        text-align: center;
        padding: 20px;
        color: var(--text-muted);
        font-size: 13px;
      }

      .modal-footer {
        padding: 10px 14px;
        border-top: 1px solid var(--border-subtle);
        display: flex;
        gap: 6px;
        justify-content: flex-end;
      }

      .btn {
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid var(--border-subtle);
        background: transparent;
        color: var(--text-muted);
        transition: all 100ms ease;
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.04);
        color: var(--text-main);
      }

      .btn-primary {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
      }

      .btn-primary:hover {
        background: var(--accent-strong);
        border-color: var(--accent-strong);
      }

      .btn-danger {
        color: #ff6b6b;
        border-color: transparent;
        padding: 4px 8px;
        font-size: 10px;
      }

      .btn-danger:hover {
        background: rgba(255, 107, 107, 0.12);
      }

      /* Help modal shortcuts list */
      .shortcuts-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .shortcuts-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-subtle);
      }

      .shortcuts-list li:last-child {
        border-bottom: none;
      }

      .shortcut-label {
        font-size: 13px;
        color: var(--text-main);
      }

      .shortcut-keys {
        display: flex;
        gap: 4px;
      }

      .shortcut-keys kbd {
        font-family: "JetBrains Mono", SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 11px;
        padding: 2px 5px;
        border-radius: 4px;
        border: 1px solid var(--border-subtle);
        background: var(--bg);
        color: var(--text-muted);
      }

      /* Footer help button */
      .help-btn {
        background: none;
        border: 1px solid var(--border-subtle);
        border-radius: 4px;
        padding: 2px 8px;
        font-size: 11px;
        color: var(--text-muted);
        cursor: pointer;
        transition: background 100ms ease, color 100ms ease;
      }

      .help-btn:hover {
        background: var(--accent-soft);
        color: var(--accent-strong);
      }

      /* Save prompt input */
      .save-input {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid var(--border-subtle);
        border-radius: 5px;
        background: var(--bg);
        color: var(--text-main);
        font-size: 12px;
        box-sizing: border-box;
      }

      .save-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      /* Toolbar button */
      .toolbar-btn {
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text-muted);
        cursor: pointer;
        transition: all 120ms ease;
        font-weight: 500;
      }

      .toolbar-btn:hover {
        background: var(--accent-soft);
        color: var(--accent-strong);
        border-color: rgba(79, 140, 255, 0.3);
      }

      :root[data-theme="light"] .toolbar-btn {
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: rgba(0, 0, 0, 0.03);
      }

      /* Confirm modal text */
      .confirm-text {
        font-size: 14px;
        color: var(--text-main);
        line-height: 1.5;
        text-align: center;
        padding: 8px 0;
      }

      .confirm-actions {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-top: 4px;
      }
</style>
  </head>
  <body>
    <div class="shell">
      <header class="toolbar">
        <div class="left-group">
          <div class="window-controls">
            <button class="window-btn window-close" id="window-close-btn"></button>
          </div>
          <div class="note-title">xnote</div>
          <div class="pill">Local backup</div>
        </div>
        <div class="right-group">
          <button class="toolbar-btn" id="new-btn">New</button>
          <button class="toolbar-btn" id="open-btn">Open</button>
          <button class="toolbar-btn" id="download-btn">Download</button>
          <button class="toolbar-btn" id="share-btn">Share</button>
          <div class="toggle-group" id="mode-toggle">
            <button type="button" data-mode="rich">Rich</button>
            <button type="button" data-mode="md">Markdown</button>
          </div>
          <div class="toggle-group" id="theme-toggle">
            <button type="button" data-theme="dark">Dark</button>
            <button type="button" data-theme="light">Light</button>
          </div>
        </div>
      </header>

      <div class="body">
        <section class="pane">
          <div class="pane-header">
            <div class="pane-title" id="left-pane-title">Editor</div>
          </div>
          <div class="pane-body">
            <div
              id="rich-editor"
              contenteditable="true"
              spellcheck="false"
              data-placeholder="Type, paste, drag files. Rich scratchpad."
            ></div>
            <textarea
              id="md-input"
              class="hidden"
              spellcheck="false"
              placeholder="# Markdown mode

Type markdown here, preview on the right updates as you type."
            ></textarea>
          </div>
        </section>

        <section class="pane hidden" id="right-pane">
          <div class="pane-header">
            <div class="pane-title">Preview</div>
            <div class="pane-sub">Markdown to HTML, code highlighted</div>
          </div>
          <div class="pane-body">
            <div id="md-preview"></div>
          </div>
        </section>
      </div>

      <footer class="status-bar">
        <div class="status-left">
          <div class="status-dot" id="status-dot"></div>
          <span class="status-label" id="status-label">Saved</span>
          <span class="status-time" id="status-time"></span>
        </div>
        <div class="status-right">
          <span>LocalStorage only</span>
          <button class="help-btn" id="help-btn">Shortcuts</button>
        </div>
      </footer>
    </div>

    <!-- Notes Modal -->
    <div class="modal-overlay" id="notes-modal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">Saved Notes</div>
          <button class="modal-close" id="notes-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <input type="text" class="modal-search" id="notes-search" placeholder="Search notes..." />
          <ul class="notes-list" id="notes-list"></ul>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="new-note-btn">New Note</button>
        </div>
      </div>
    </div>

    <!-- Save Modal -->
    <div class="modal-overlay" id="save-modal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">Save Note</div>
          <button class="modal-close" id="save-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <input type="text" class="save-input" id="save-name-input" placeholder="Enter note name..." />
        </div>
        <div class="modal-footer">
          <button class="btn" id="save-cancel-btn">Cancel</button>
          <button class="btn btn-primary" id="save-confirm-btn">Save</button>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">Keyboard Shortcuts</div>
          <button class="modal-close" id="help-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <ul class="shortcuts-list">
            <li>
              <span class="shortcut-label">New Note</span>
              <div class="shortcut-keys"><kbd>Cmd</kbd><kbd>N</kbd></div>
            </li>
            <li>
              <span class="shortcut-label">Open Notes</span>
              <div class="shortcut-keys"><kbd>Cmd</kbd><kbd>O</kbd></div>
            </li>
            <li>
              <span class="shortcut-label">Quick Save</span>
              <div class="shortcut-keys"><kbd>Cmd</kbd><kbd>S</kbd></div>
            </li>
            <li>
              <span class="shortcut-label">Save As</span>
              <div class="shortcut-keys"><kbd>Cmd</kbd><kbd>Shift</kbd><kbd>S</kbd></div>
            </li>
            <li>
              <span class="shortcut-label">Download Note</span>
              <div class="shortcut-keys"><kbd>Cmd</kbd><kbd>D</kbd></div>
            </li>
            <li>
              <span class="shortcut-label">Rich Mode</span>
              <div class="shortcut-keys"><kbd>Cmd</kbd><kbd>1</kbd></div>
            </li>
            <li>
              <span class="shortcut-label">Markdown Mode</span>
              <div class="shortcut-keys"><kbd>Cmd</kbd><kbd>2</kbd></div>
            </li>
            <li>
              <span class="shortcut-label">Toggle Theme</span>
              <div class="shortcut-keys"><kbd>Cmd</kbd><kbd>T</kbd></div>
            </li>
            <li>
              <span class="shortcut-label">Show Shortcuts</span>
              <div class="shortcut-keys"><kbd>Cmd</kbd><kbd>/</kbd></div>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="share-modal">
      <div class="modal" style="max-width: 360px;">
        <div class="modal-header">
          <div class="modal-title">Share Note</div>
          <button class="modal-close" id="share-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="confirm-text" id="share-status">Choose visibility for your shared note:</div>
          <div class="confirm-actions" id="share-options">
            <button class="btn" id="share-secret-btn">Secret</button>
            <button class="btn btn-primary" id="share-public-btn">Public</button>
          </div>
          <div class="hidden" id="share-result">
            <input type="text" class="save-input" id="share-url" readonly style="margin-bottom: 8px;" />
            <div class="confirm-actions">
              <button class="btn btn-primary" id="copy-url-btn">Copy URL</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirm-modal">
      <div class="modal" style="max-width: 340px;">
        <div class="modal-header">
          <div class="modal-title" id="confirm-title">Confirm</div>
          <button class="modal-close" id="confirm-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="confirm-text" id="confirm-text"></div>
          <div class="confirm-actions">
            <button class="btn" id="confirm-cancel-btn">Cancel</button>
            <button class="btn btn-primary" id="confirm-ok-btn">OK</button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"
      integrity="sha512-8t02S+6B7qJk41bwkCmOMkmok+wxgHgMD+hE+zqkpQVwm+T1By+WGuqJC986KqthHz7jCB4djFZPccsE15ZkJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/turndown/dist/turndown.js"></script>

    <script>
      // Check if running in Electron
      const isElectron = window.electronAPI !== undefined;

      const KEY_RICH = "richContent";
      const KEY_MD = "mdContent";
      const KEY_THEME = "theme";
      const KEY_MODE = "mode";
      const KEY_NOTES = "notes";
      const KEY_CURRENT = "currentNote";

      // Storage abstraction for Electron/Browser compatibility
      const storage = {
        async get(key) {
          if (isElectron) {
            return await window.electronAPI.getData(key);
          }
          const val = localStorage.getItem(key);
          try {
            return JSON.parse(val);
          } catch {
            return val;
          }
        },
        async set(key, value) {
          if (isElectron) {
            await window.electronAPI.setData(key, value);
          } else {
            localStorage.setItem(key, typeof value === 'string' ? value : JSON.stringify(value));
          }
        }
      };

      const root = document.documentElement;
      const body = document.body;
      const rich = document.getElementById("rich-editor");
      const mdInput = document.getElementById("md-input");
      const mdPreview = document.getElementById("md-preview");
      const rightPane = document.getElementById("right-pane");
      const leftPaneTitle = document.getElementById("left-pane-title");

      const statusDot = document.getElementById("status-dot");
      const statusLabel = document.getElementById("status-label");
      const statusTime = document.getElementById("status-time");

      const modeToggle = document.getElementById("mode-toggle");
      const themeToggle = document.getElementById("theme-toggle");

      // Modal elements
      const notesModal = document.getElementById("notes-modal");
      const saveModal = document.getElementById("save-modal");
      const helpModal = document.getElementById("help-modal");
      const confirmModal = document.getElementById("confirm-modal");
      const shareModal = document.getElementById("share-modal");
      const notesSearch = document.getElementById("notes-search");
      const notesList = document.getElementById("notes-list");
      const saveNameInput = document.getElementById("save-name-input");
      const helpBtn = document.getElementById("help-btn");
      const openBtn = document.getElementById("open-btn");
      const newBtn = document.getElementById("new-btn");
      const downloadBtn = document.getElementById("download-btn");
      const shareBtn = document.getElementById("share-btn");
      const confirmText = document.getElementById("confirm-text");
      const confirmTitle = document.getElementById("confirm-title");

      let saveTimer = null;
      let currentNoteName = null;
      let confirmCallback = null;

      function nowClock() {
        const d = new Date();
        return (
          String(d.getHours()).padStart(2, "0") +
          ":" +
          String(d.getMinutes()).padStart(2, "0") +
          ":" +
          String(d.getSeconds()).padStart(2, "0")
        );
      }

      function setStatusSaving() {
        statusLabel.textContent = "Saving";
        statusDot.style.boxShadow = "0 0 0 6px rgba(79, 140, 255, 0.26)";
      }

      function setStatusSaved() {
        statusLabel.textContent = "Saved";
        statusTime.textContent = " at " + nowClock();
        statusDot.style.boxShadow = "0 0 0 4px rgba(79, 140, 255, 0.18)";
      }

      function debounceSaved(fn) {
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(fn, 260);
      }

      function highlightCodeBlocks(container) {
        container.querySelectorAll("pre code").forEach((block) => {
          hljs.highlightElement(block);
        });
      }

      async function loadInitialState() {
        const richContent = await storage.get(KEY_RICH) || "";
        rich.innerHTML = richContent;
        rich.dataset.hasContent = richContent.trim().length > 0;

        const mdContent = await storage.get(KEY_MD) || "";
        mdInput.value = mdContent;
        updateMarkdownPreview();

        const savedTheme = await storage.get(KEY_THEME) || "dark";
        applyTheme(savedTheme, false);

        const savedMode = await storage.get(KEY_MODE) || "rich";
        applyMode(savedMode, false);

        // Load current note name if any
        currentNoteName = await storage.get(KEY_CURRENT) || null;

        setStatusSaved();
      }

      function applyTheme(theme, persist = true) {
        root.setAttribute("data-theme", theme);
        themeToggle.querySelectorAll("button").forEach((btn) => {
          btn.classList.toggle("is-active", btn.dataset.theme === theme);
        });
        if (persist) storage.set(KEY_THEME, theme);
      }


      function applyMode(mode, persist = true) {
        const isRich = mode === "rich";
        rich.classList.toggle("hidden", !isRich);
        mdInput.classList.toggle("hidden", isRich);
        rightPane.classList.toggle("hidden", isRich);
        leftPaneTitle.textContent = isRich ? "Editor" : "Markdown";

        // Hide pane header in rich mode for more space
        const leftPaneHeader = leftPaneTitle.closest(".pane-header");
        if (leftPaneHeader) {
          leftPaneHeader.classList.toggle("hidden", isRich);
        }

        modeToggle.querySelectorAll("button").forEach((btn) => {
          btn.classList.toggle("is-active", btn.dataset.mode === mode);
        });

        if (!isRich) {
          updateMarkdownPreview();
        }

        if (persist) storage.set(KEY_MODE, mode);
      }

      function saveRich() {
        const html = rich.innerHTML;
        storage.set(KEY_RICH, html);
        rich.dataset.hasContent = html.trim().length > 0;
        setStatusSaved();
      }

      function saveMarkdown() {
        const text = mdInput.value;
        storage.set(KEY_MD, text);
        setStatusSaved();
      }

      function updateMarkdownPreview() {
        const raw = mdInput.value || "";
        if (!raw.trim()) {
          mdPreview.innerHTML = "<p style=\"opacity:0.4\">Live preview. Paste markdown on the left.</p>";
          return;
        }
        const html = marked.parse(raw, { breaks: true });
        mdPreview.innerHTML = html;
        highlightCodeBlocks(mdPreview);
      }

      rich.addEventListener("input", () => {
        setStatusSaving();
        debounceSaved(saveRich);
      });

      let previewTimer = null;

      function debouncePreview(fn) {
        if (previewTimer) clearTimeout(previewTimer);
        previewTimer = setTimeout(fn, 100);
      }

      mdInput.addEventListener("input", () => {
        setStatusSaving();
        debouncePreview(updateMarkdownPreview);
        debounceSaved(saveMarkdown);
      });

      themeToggle.addEventListener("click", (event) => {
        const btn = event.target.closest("button[data-theme]");
        if (!btn) return;
        applyTheme(btn.dataset.theme);
      });


      modeToggle.addEventListener("click", (event) => {
        const btn = event.target.closest("button[data-mode]");
        if (!btn) return;
        applyMode(btn.dataset.mode);
      });

      // Notes management functions
      async function getNotes() {
        const data = await storage.get(KEY_NOTES);
        return data || [];
      }

      async function saveNotes(notes) {
        await storage.set(KEY_NOTES, notes);
      }

      function formatDate(timestamp) {
        const d = new Date(timestamp);
        return d.toLocaleDateString() + " " + d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      }

      // Modal functions
      function openModal(modal) {
        modal.classList.add("is-visible");
        document.body.style.overflow = "hidden";
      }

      function closeModal(modal) {
        modal.classList.remove("is-visible");
        document.body.style.overflow = "";
      }

      function closeAllModals() {
        closeModal(notesModal);
        closeModal(saveModal);
        closeModal(helpModal);
        closeModal(confirmModal);
        closeModal(shareModal);
        confirmCallback = null;
      }

      // Themed confirm dialog
      function showConfirm(message, title = "Confirm") {
        return new Promise((resolve) => {
          confirmTitle.textContent = title;
          confirmText.textContent = message;
          confirmCallback = resolve;
          openModal(confirmModal);
        });
      }

      // Notes modal
      async function renderNotesList(filter = "") {
        const notes = await getNotes();
        const filtered = filter
          ? notes.filter((n) => n.name.toLowerCase().includes(filter.toLowerCase()))
          : notes;

        if (filtered.length === 0) {
          notesList.innerHTML = '<li class="notes-empty">No notes found</li>';
          return;
        }

        // Sort by date, newest first
        filtered.sort((a, b) => b.updatedAt - a.updatedAt);

        notesList.innerHTML = filtered
          .map(
            (note) => `
          <li class="notes-list-item" data-name="${note.name}">
            <div>
              <div class="note-name">${note.name}</div>
              <div class="note-date">${formatDate(note.updatedAt)}</div>
            </div>
            <button class="btn btn-danger delete-note-btn" data-name="${note.name}">Delete</button>
          </li>
        `
          )
          .join("");
      }

      function openNotesModal() {
        notesSearch.value = "";
        renderNotesList();
        openModal(notesModal);
        notesSearch.focus();
      }

      async function loadNote(name) {
        const notes = await getNotes();
        const note = notes.find((n) => n.name === name);
        if (!note) return;

        // Load content
        rich.innerHTML = note.richContent || "";
        rich.dataset.hasContent = (note.richContent || "").trim().length > 0;
        mdInput.value = note.mdContent || "";
        updateMarkdownPreview();

        // Save to working storage
        await storage.set(KEY_RICH, note.richContent || "");
        await storage.set(KEY_MD, note.mdContent || "");

        currentNoteName = name;
        await storage.set(KEY_CURRENT, name);

        closeModal(notesModal);
        setStatusSaved();
      }

      async function deleteNote(name) {
        const confirmed = await showConfirm(`Delete "${name}"?`, "Delete Note");
        if (!confirmed) return;

        const notes = (await getNotes()).filter((n) => n.name !== name);
        await saveNotes(notes);

        if (currentNoteName === name) {
          currentNoteName = null;
          await storage.set(KEY_CURRENT, null);
        }

        await renderNotesList(notesSearch.value);
      }

      // Save modal
      function openSaveModal() {
        saveNameInput.value = currentNoteName || "";
        openModal(saveModal);
        saveNameInput.focus();
        saveNameInput.select();
      }

      async function saveCurrentNote() {
        const name = saveNameInput.value.trim();
        if (!name) {
          saveNameInput.focus();
          return;
        }

        await saveNoteWithName(name);
        closeModal(saveModal);
      }

      // Save note with a specific name (used by both quick save and save modal)
      async function saveNoteWithName(name) {
        const notes = await getNotes();
        const existing = notes.findIndex((n) => n.name === name);

        const noteData = {
          name,
          richContent: rich.innerHTML,
          mdContent: mdInput.value,
          updatedAt: Date.now(),
        };

        if (existing >= 0) {
          notes[existing] = noteData;
        } else {
          notes.push(noteData);
        }

        await saveNotes(notes);
        currentNoteName = name;
        await storage.set(KEY_CURRENT, name);
        setStatusSaved();
      }

      // Quick save - saves directly if note has a name, otherwise opens modal
      async function quickSave() {
        if (currentNoteName) {
          await saveNoteWithName(currentNoteName);
        } else {
          openSaveModal();
        }
      }

      // New note
      async function createNewNote() {
        rich.innerHTML = "";
        rich.dataset.hasContent = "false";
        mdInput.value = "";
        updateMarkdownPreview();

        await storage.set(KEY_RICH, "");
        await storage.set(KEY_MD, "");

        currentNoteName = null;
        await storage.set(KEY_CURRENT, null);

        closeAllModals();
        setStatusSaved();

        // Focus the appropriate editor
        const mode = await storage.get(KEY_MODE) || "rich";
        if (mode === "rich") {
          rich.focus();
        } else {
          mdInput.focus();
        }
      }

      // Event listeners for modals
      notesSearch.addEventListener("input", () => {
        renderNotesList(notesSearch.value);
      });

      notesList.addEventListener("click", (event) => {
        const deleteBtn = event.target.closest(".delete-note-btn");
        if (deleteBtn) {
          deleteNote(deleteBtn.dataset.name);
          return;
        }

        const item = event.target.closest(".notes-list-item");
        if (item) {
          loadNote(item.dataset.name);
        }
      });

      document.getElementById("notes-modal-close").addEventListener("click", () => closeModal(notesModal));
      document.getElementById("save-modal-close").addEventListener("click", () => closeModal(saveModal));
      document.getElementById("help-modal-close").addEventListener("click", () => closeModal(helpModal));

      document.getElementById("new-note-btn").addEventListener("click", createNewNote);
      document.getElementById("save-cancel-btn").addEventListener("click", () => closeModal(saveModal));
      document.getElementById("save-confirm-btn").addEventListener("click", saveCurrentNote);

      helpBtn.addEventListener("click", () => openModal(helpModal));
      openBtn.addEventListener("click", openNotesModal);
      newBtn.addEventListener("click", createNewNote);

      // Download note as markdown
      async function downloadNote() {
        // Get the markdown content - prefer md mode content, or convert rich content
        let content = mdInput.value;

        // If in rich mode and no markdown content, use the rich content (as plain text)
        if (!content.trim() && rich.innerHTML.trim()) {
          // Convert HTML to basic markdown-ish text
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = rich.innerHTML;
          content = tempDiv.innerText || tempDiv.textContent || '';
        }

        if (!content.trim()) {
          await showConfirm("Nothing to download. The note is empty.", "Download");
          return;
        }

        // Generate suggested filename
        const suggestedName = currentNoteName
          ? currentNoteName.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.md'
          : 'note.md';

        if (isElectron) {
          const result = await window.electronAPI.downloadMarkdown(content, suggestedName);
          if (result.success) {
            // Optionally show success feedback
            statusLabel.textContent = "Downloaded";
            statusTime.textContent = " at " + nowClock();
            setTimeout(() => setStatusSaved(), 2000);
          } else if (result.error) {
            await showConfirm("Failed to save: " + result.error, "Error");
          }
        } else {
          // Browser fallback: use download link
          const blob = new Blob([content], { type: 'text/markdown' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = suggestedName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }
      }

      downloadBtn.addEventListener("click", downloadNote);

      // Share functionality
      const turndownService = new TurndownService({
        headingStyle: 'atx',
        codeBlockStyle: 'fenced'
      });

      function getShareContent() {
        let content = mdInput.value;
        if (!content.trim() && rich.innerHTML.trim()) {
          // Convert HTML to Markdown using Turndown
          content = turndownService.turndown(rich.innerHTML);
        }
        return content;
      }

      function resetShareModal() {
        document.getElementById("share-status").textContent = "Choose visibility for your shared note:";
        document.getElementById("share-options").classList.remove("hidden");
        document.getElementById("share-result").classList.add("hidden");
        document.getElementById("share-url").value = "";
      }

      async function shareNote(isPublic) {
        const content = getShareContent();
        if (!content.trim()) {
          await showConfirm("Nothing to share. The note is empty.", "Share");
          return;
        }

        const filename = currentNoteName
          ? currentNoteName.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.md'
          : 'note.md';

        document.getElementById("share-status").textContent = "Creating gist...";
        document.getElementById("share-options").classList.add("hidden");

        const result = await window.electronAPI.shareGist(content, filename, isPublic);

        if (result.success) {
          document.getElementById("share-status").textContent = isPublic ? "Public gist created!" : "Secret gist created!";
          document.getElementById("share-url").value = result.url;
          document.getElementById("share-result").classList.remove("hidden");
        } else {
          document.getElementById("share-status").textContent = "Error: " + result.error;
          document.getElementById("share-options").classList.remove("hidden");
        }
      }

      shareBtn.addEventListener("click", () => {
        if (!isElectron) {
          showConfirm("Share is only available in the desktop app.", "Share");
          return;
        }
        const content = getShareContent();
        if (!content.trim()) {
          showConfirm("Nothing to share. The note is empty.", "Share");
          return;
        }
        resetShareModal();
        openModal(shareModal);
      });

      document.getElementById("share-modal-close").addEventListener("click", () => closeModal(shareModal));
      document.getElementById("share-secret-btn").addEventListener("click", () => shareNote(false));
      document.getElementById("share-public-btn").addEventListener("click", () => shareNote(true));
      document.getElementById("copy-url-btn").addEventListener("click", () => {
        const urlInput = document.getElementById("share-url");
        urlInput.select();
        document.execCommand("copy");
        document.getElementById("copy-url-btn").textContent = "Copied!";
        setTimeout(() => {
          document.getElementById("copy-url-btn").textContent = "Copy URL";
        }, 1500);
      });

      // Confirm modal handlers
      document.getElementById("confirm-modal-close").addEventListener("click", () => {
        if (confirmCallback) confirmCallback(false);
        closeModal(confirmModal);
        confirmCallback = null;
      });

      document.getElementById("confirm-cancel-btn").addEventListener("click", () => {
        if (confirmCallback) confirmCallback(false);
        closeModal(confirmModal);
        confirmCallback = null;
      });

      document.getElementById("confirm-ok-btn").addEventListener("click", () => {
        if (confirmCallback) confirmCallback(true);
        closeModal(confirmModal);
        confirmCallback = null;
      });

      // Close modals on overlay click
      [notesModal, saveModal, helpModal, confirmModal].forEach((modal) => {
        modal.addEventListener("click", (event) => {
          if (event.target === modal) {
            if (modal === confirmModal && confirmCallback) {
              confirmCallback(false);
              confirmCallback = null;
            }
            closeModal(modal);
          }
        });
      });

      // Close modals on Escape
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeAllModals();
        }
      });

      // Enter to save in save modal
      saveNameInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          saveCurrentNote();
        }
      });

      window.addEventListener("keydown", (event) => {
        const ctrlOrMeta = event.ctrlKey || event.metaKey;
        const key = event.key.toLowerCase();

        if (!ctrlOrMeta) return;

        // Cmd+/ for help
        if (key === "/") {
          openModal(helpModal);
          event.preventDefault();
          return;
        }

        // Cmd+O for open
        if (key === "o") {
          openNotesModal();
          event.preventDefault();
          return;
        }

        // Cmd+Shift+S for Save As (always show modal)
        if (key === "s" && event.shiftKey) {
          openSaveModal();
          event.preventDefault();
          return;
        }

        // Cmd+S for quick save
        if (key === "s") {
          quickSave();
          event.preventDefault();
          return;
        }

        // Cmd+N for new
        if (key === "n") {
          createNewNote();
          event.preventDefault();
          return;
        }

        // Cmd+D for download
        if (key === "d") {
          downloadNote();
          event.preventDefault();
          return;
        }

        // Cmd+T for toggle theme
        if (key === "t") {
          storage.get(KEY_THEME).then(current => {
            applyTheme((current || "dark") === "dark" ? "light" : "dark");
          });
          event.preventDefault();
          return;
        }

        // Cmd+1 for Rich mode
        if (key === "1") {
          applyMode("rich");
          event.preventDefault();
          return;
        }

        // Cmd+2 for Markdown mode
        if (key === "2") {
          applyMode("md");
          event.preventDefault();
          return;
        }

        // Cmd+W to hide window (Electron)
        if (key === "w" && isElectron) {
          window.electronAPI.hideWindow();
          event.preventDefault();
          return;
        }
      });

      window.addEventListener("load", () => {
        loadInitialState();
      });

      // Window close button (Electron)
      const windowCloseBtn = document.getElementById("window-close-btn");
      if (windowCloseBtn) {
        windowCloseBtn.addEventListener("click", () => {
          if (isElectron) {
            window.electronAPI.hideWindow();
          }
        });
      }
    </script>
  </body>
</html>
